import giveawayhandler as gh
import json
from os.path import exists as file_exists
if __name__ == "__main__":
	while True:
		# Load users
		with open('saved_SIDs.json', 'r') as file:
			SIDs = json.load(file)
		if file_exists('saved_users.json'):
			with open('saved_users.json', 'r') as file:
				user_dicts = json.load(file)
			old_users = [i.get('username') for i in user_dicts]
			new_users = [i for i in SIDs if i not in old_users]
			users = [gh.User.from_dict(i) for i in user_dicts]
			new_users = [gh.User(i, SIDs.get(i)) for i in new_users]
			users.extend(new_users)
		else:
			users = [gh.User(i, SIDs.get(i)) for i in SIDs]

		# Sign users up to everything
		try:
			for user in users:
				print(f'{user.username}')
				user.update_giveaways()
				user.sign_up_for_everything()
		except Exception:
			user_dicts = [i.to_dict() for i in users]
			with open('saved_users.json', 'w') as file:
				json.dump(user_dicts, file)
			raise
		except KeyboardInterrupt:
			user_dicts = [i.to_dict() for i in users]
			with open('saved_users.json', 'w') as file:
				json.dump(user_dicts, file)
			raise

		# Save users
		user_dicts = [i.to_dict() for i in users]
		with open('saved_users.json', 'w') as file:
			json.dump(user_dicts, file)
